## Как работает сервис

Раз в сутки запускается скрипт `build_queues.php`, который сначала заполняет очередь на отправку писем, которые уже готовы к отправке (емэйл подтверждён и подписка истекает через день или через три). Затем заполняет очередь на проверку емэйлов (подписка истекает через день или через три, емэйл не подтверждён и проверка емэйла функцией check_email не запускалась).  

Каждую минуту запускаются по 20 (см. объяснение ниже) консьюмеров на каждую из очередей (см. `crontab.txt`). Каждый консьюмер обрабатывает только свои записи.  

Итого на отправку писем мы будем тратить 6 часов и 20 тысяч рублей денег раз в день. Эти цифры можно менять в зависимости от того, что нужно бизнесу (ускорить, накинув консьюмеров; убрать проверку емэйлов, чтобы не тратить деньги на это; слать письма на все емэйлы, не проверяя).

## Допущения

1. В задаче не сказано, может ли пользователь оформить подписку без подтверждённого емэйла. Если бы подписка оформлялась только с подтверждённым емэйлом, то смысла в функции `check_email` не было бы. Поэтому считаю, что если подписка оформлена, это не значит, что емэйл подтверждён.
2. Если `confirmed = 1`, то емэйл точно дойдёт.
3. `Очереди реализовать без использования менеджеров` - не понял, что такое `менеджеры`. Очереди реализую прямо в БД (см. комментарий ниже).
4. Не понятно, сколько емэйлов будем отправлять каждый день. Ясно только, что юзеров с подпиской `1 000 000+`. Считаю, что большинство подписок оформляются на 1, 2 или 3 месяца. Т.е. в течение ближайших 90 дней (для простоты счёта возьму 100) все подписки истекут, каждый день истекает 1/100 подписок. 1 000 000 / 100 = 10 000 подписок истекает в день. Т.о. `каждые сутки будем отправлять около 20 000+ писем`.
5. В `validts` использую `null` вместо `0`. И колонку переименовал на `expires_at`, т.к. нет смысла хранить тип данных `ts` в названии колонки.
6. В задаче сказано, что `validts` имеет тип `timestamp`. Но зачем, если мы хотим знать только дату, когда истекает подписка. Поменял на `date`.
7. Емэйлы пользователей уникальны.
8. Не совсем понятно, в какое время мы должны послать письмо о том, что подписка истекает `за один день`. Считаю, что если подписка истекает 10 февраля в 23:59, то письмо шлём 9 февраля примерно в 00:01.
9. Не совсем понятно, в какое время мы должны послать письмо о том, что подписка истекает `за три дня`. Считаю, что если подписка истекает 10 февраля в 23:59, то письмо шлём 7 февраля примерно в 00:01.
10. После вызова `check_email` может упасть ошибка при сохранении к нам в БД. Я этот кейс не обрабатывал, чтобы не переусложнить. Хотя по идее от этого надо как-то засчититься, раз вызов функции платный. Чтобы не начать в цикле бесконечно вызывать эту функцию.
11. Гарантия доставки письма будет `at least once`.
12. Я сделал partial индекс. Запись в таблицу users будет работать медленнее. Предполагаю, что запись в эту таблицу происходит редко, и это не зааффектит сильно систему.

## Обработка очередей

Писем 20 тысяч, из них примерно 15% с подтверждёнными емэйлами, значит для остальных 85% нужно вызывать check_email.  

20 000 * 85% * 10 секунд = 47 часов будут отправляться письма одним консьюмером. Я сделал 20 консьюмеров. Итого 3 часа на обработку очереди проверки емэйлов и 3 часа на отправку самих писем. Итого за `6 часов` отправятся все письма в худшем случае.  

Необходимо настроить мониторинги и алерты. Чтобы в случае роста кол-ва писем накинуть консьюмеров.  

Если кол-во отправляемых писем будет кратно расти, необходимо перевести обработку очередей на `rabbitmq`. Он позволяет легко увеличивать кол-во консьюмеров.
